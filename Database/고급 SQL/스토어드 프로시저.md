# 스토어드 프로시저 (Stored Procedure)

## 개념

데이터베이스에 저장된 **재사용 가능한 SQL 코드 집합**

### 특징
- 미리 컴파일되어 DB에 저장
- 매개변수 사용 가능
- 여러 SQL문을 하나의 단위로 실행
- 프로그래밍 로직 포함 (IF, LOOP 등)

## 기본 문법

### 생성
```sql
-- MySQL
DELIMITER //
CREATE PROCEDURE 프로시저명(매개변수)
BEGIN
    SQL 문장들;
END //
DELIMITER ;

-- 실행
CALL 프로시저명(값);

-- 삭제
DROP PROCEDURE 프로시저명;
```

## 사용 예시

### 1. 기본 프로시저
```sql
DELIMITER //
CREATE PROCEDURE GetEmployeeCount()
BEGIN
    SELECT COUNT(*) AS total FROM employees;
END //
DELIMITER ;

-- 실행
CALL GetEmployeeCount();
```

### 2. 매개변수 사용
```sql
-- IN: 입력 매개변수
DELIMITER //
CREATE PROCEDURE GetEmployeesByDept(IN dept_id INT)
BEGIN
    SELECT * FROM employees WHERE department_id = dept_id;
END //
DELIMITER ;

CALL GetEmployeesByDept(10);
```

### 3. OUT 매개변수
```sql
-- OUT: 출력 매개변수
DELIMITER //
CREATE PROCEDURE GetAvgSalary(IN dept_id INT, OUT avg_sal DECIMAL(10,2))
BEGIN
    SELECT AVG(salary) INTO avg_sal
    FROM employees
    WHERE department_id = dept_id;
END //
DELIMITER ;

CALL GetAvgSalary(10, @result);
SELECT @result;
```

### 4. 조건문 사용
```sql
DELIMITER //
CREATE PROCEDURE UpdateSalary(IN emp_id INT, IN amount DECIMAL(10,2))
BEGIN
    DECLARE current_sal DECIMAL(10,2);
    
    SELECT salary INTO current_sal FROM employees WHERE employee_id = emp_id;
    
    IF current_sal + amount > 10000000 THEN
        SELECT '급여 상한 초과' AS message;
    ELSE
        UPDATE employees SET salary = salary + amount WHERE employee_id = emp_id;
    END IF;
END //
DELIMITER ;
```

### 5. 반복문 사용
```sql
DELIMITER //
CREATE PROCEDURE InsertTestData(IN count INT)
BEGIN
    DECLARE i INT DEFAULT 1;
    
    WHILE i <= count DO
        INSERT INTO test_table (value) VALUES (i);
        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;
```

## 장점

| 장점 | 설명 |
|------|------|
| 성능 향상 | 미리 컴파일, 실행 계획 저장 |
| 네트워크 부하 감소 | 여러 SQL을 한 번에 전송 |
| 보안 강화 | 직접 테이블 접근 차단, 프로시저만 실행 |
| 재사용성 | 여러 곳에서 동일 로직 사용 |
| 유지보수 | 중앙 집중식 관리 |

## 단점

| 단점 | 설명 |
|------|------|
| 이식성 낮음 | DBMS별 문법 상이 |
| 디버깅 어려움 | 별도 도구 필요 |
| 버전 관리 | Git 등에서 관리 어려움 |
| 복잡도 증가 | 비즈니스 로직 분산 |

## 프로시저 vs 함수

| 구분 | 프로시저 | 함수 |
|------|---------|------|
| 호출 | CALL | SELECT |
| 반환값 | 여러 개 (OUT) | 하나 |
| 트랜잭션 | 가능 | 제한적 |
| DML | 가능 | 제한적 |
| 용도 | 작업 수행 | 값 계산 |
```sql
-- 프로시저
CALL UpdateEmployee(100);

-- 함수
SELECT CalculateBonus(salary) FROM employees;
```

## 실전 예시

### 트랜잭션 처리
```sql
DELIMITER //
CREATE PROCEDURE TransferMoney(
    IN from_account INT,
    IN to_account INT,
    IN amount DECIMAL(10,2)
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT '이체 실패' AS message;
    END;
    
    START TRANSACTION;
    
    UPDATE accounts SET balance = balance - amount WHERE account_id = from_account;
    UPDATE accounts SET balance = balance + amount WHERE account_id = to_account;
    
    COMMIT;
    SELECT '이체 성공' AS message;
END //
DELIMITER ;
```

### 에러 처리
```sql
DELIMITER //
CREATE PROCEDURE SafeInsert(IN name VARCHAR(50))
BEGIN
    DECLARE CONTINUE HANDLER FOR 1062  -- Duplicate key error
    SELECT '중복된 이름입니다' AS error;
    
    INSERT INTO users (name) VALUES (name);
    SELECT '추가 완료' AS message;
END //
DELIMITER ;
```

## 프로시저 조회
```sql
-- 프로시저 목록
SHOW PROCEDURE STATUS WHERE Db = 'database_name';

-- 프로시저 정의 확인
SHOW CREATE PROCEDURE 프로시저명;

-- 프로시저 정보
SELECT * FROM information_schema.ROUTINES
WHERE ROUTINE_TYPE = 'PROCEDURE';
```

## 사용 가이드

**프로시저 사용 시**:
- 복잡한 비즈니스 로직
- 트랜잭션 관리 필요
- 배치 작업
- 공통 로직 재사용

**프로시저 지양 시**:
- 단순 조회
- ORM 사용 환경
- 빈번한 로직 변경
- 여러 DBMS 지원 필요

## 참고 자료

- [MySQL Stored Procedure](https://dev.mysql.com/doc/refman/8.0/en/stored-routines.html)
- [Oracle PL/SQL](https://docs.oracle.com/en/database/oracle/oracle-database/19/lnpls/)